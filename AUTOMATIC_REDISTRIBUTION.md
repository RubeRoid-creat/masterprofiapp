# üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–ï–†–ï–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–°–¢–ï–ö–®–ò–• –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô

## üéØ –§–£–ù–ö–¶–ò–û–ù–ê–õ

–ö–æ–≥–¥–∞ –º–∞—Å—Ç–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞—è–≤–∫—É –≤ —Ç–µ—á–µ–Ω–∏–µ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (5 –º–∏–Ω—É—Ç), —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ `expired`
2. ‚úÖ –ò—â–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
3. ‚úÖ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
4. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–º—É –º–∞—Å—Ç–µ—Ä—É

## ‚öôÔ∏è –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### 1. –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä:
```javascript
const timeout = calculateTimeout(attemptNumber); // 5 –º–∏–Ω—É—Ç –¥–ª—è –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
const timer = setTimeout(() => {
  handleAssignmentExpiration(assignmentId, orderId);
}, timeout);
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

–§—É–Ω–∫—Ü–∏—è `handleAssignmentExpiration`:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `expired`
- –í—ã–∑—ã–≤–∞–µ—Ç `findNextMaster()` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞

### 3. –ü–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞

–§—É–Ω–∫—Ü–∏—è `findNextMaster`:
- –ò—Å–∫–ª—é—á–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ (—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –Ω–∞ —Å–º–µ–Ω–µ, –¥–æ—Å—Ç—É–ø–µ–Ω)
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –ø–æ–ø—ã—Ç–∫–∏ (`attempt_number`)

### 4. –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ–µ–≤)

–¢–∞–∫ –∫–∞–∫ —Ç–∞–π–º–µ—Ä—ã —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω—ã

## üìã –õ–û–ì–ò–ö–ê –ü–ï–†–ï–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–Ø

### –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:

1. **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–ª–æ:**
   - `status = 'pending'`
   - `expires_at < now()`

2. **–ó–∞–∫–∞–∑ –µ—â–µ –Ω–æ–≤—ã–π:**
   - `repair_status = 'new'`

3. **–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞:**
   - –ú–∞—Å—Ç–µ—Ä –Ω–∞ —Å–º–µ–Ω–µ (`is_on_shift = 1`)
   - –ú–∞—Å—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (`status = 'available'`)
   - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–∏–ø—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –ú–∞—Å—Ç–µ—Ä –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∞–ª —ç—Ç–æ—Ç –∑–∞–∫–∞–∑

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:

- –ú–∞–∫—Å–∏–º—É–º **5 –ø–æ–ø—ã—Ç–æ–∫** –Ω–∞ –∑–∞–∫–∞–∑
- –ü–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–∫–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (`status = 'cancelled'`)
- –ù–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `attempt_number`

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –¢–∞–π–º–∞—É—Ç –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π:

```javascript
function calculateTimeout(attemptNumber) {
  const baseTimeout = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
  // –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
  return baseTimeout;
}
```

### –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```javascript
const EXPIRED_CHECK_INTERVAL = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞
```

–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `backend/server.js`.

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
cd backend
node scripts/test-expired-redistribution.js
```

–°–∫—Ä–∏–ø—Ç:
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ pending –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –û—Ç–º–µ—á–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑:**
   ```bash
   node scripts/create-test-order.js
   ```

2. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 5 –º–∏–Ω—É—Ç** (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ `expires_at` –≤ –ë–î –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞)

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```bash
   node scripts/check-assignments.js
   ```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ä—É—á–Ω—É—é:**
   ```bash
   node -e "import('./services/assignment-service.js').then(m => m.checkAndProcessExpiredAssignments())"
   ```

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:

```
‚è∞ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 2 –∏—Å—Ç–µ–∫—à–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
‚è±Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å—Ç–µ–∫—à–µ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ #15 –¥–ª—è –∑–∞–∫–∞–∑–∞ #10
üîÑ –ù–∞–∑–Ω–∞—á–∞–µ–º –∑–∞–∫–∞–∑ #10 —Å–ª–µ–¥—É—é—â–µ–º—É –º–∞—Å—Ç–µ—Ä—É #2 (–ø–æ–ø—ã—Ç–∫–∞ 2, score: 0.403)
‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 1 –∑–∞–∫–∞–∑–æ–≤ —Å –∏—Å—Ç–µ–∫—à–∏–º–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:

```sql
-- –ò—Å—Ç–µ–∫—à–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
SELECT * FROM order_assignments 
WHERE status = 'expired' 
ORDER BY created_at DESC 
LIMIT 10;

-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∑–∞–∫–∞–∑–∞
SELECT * FROM order_assignments 
WHERE order_id = ? 
ORDER BY attempt_number ASC;
```

## ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
   - –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞: —Ç–∞–π–º–µ—Ä—ã + —Ñ–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
   - –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

2. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:**
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
   - –ó–∞–∫–∞–∑—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è

3. **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å:**
   - –ö–∞–∂–¥—ã–π –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —à–∞–Ω—Å
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–µ–π—Ç–∏–Ω–≥ –∏ –∑–∞–≥—Ä—É–∑–∫–∞

4. **–ö–æ–Ω—Ç—Ä–æ–ª—å:**
   - –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

## üêõ –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. ‚úÖ –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞ (—Å–º. –ª–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞)
2. ‚úÖ –ï—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ (–Ω–µ –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω—ã)
3. ‚úÖ –ó–∞–∫–∞–∑ –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω (`repair_status = 'new'`)

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `MAX_ATTEMPTS` –≤ `findNextMaster()`
- –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –≤ `calculateTimeout()`

### –ü—Ä–æ–±–ª–µ–º–∞: –û–¥–∏–Ω –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `excludedMasterIds` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `master_id` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

## üìù –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

- `backend/services/assignment-service.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `checkAndProcessExpiredAssignments()`
- `backend/server.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- `backend/scripts/test-expired-redistribution.js` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–∫–∞–∑—ã –º–µ–∂–¥—É –º–∞—Å—Ç–µ—Ä–∞–º–∏, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Å—Ç–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–∞–∫–∞–∑—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç –∫ –¥–æ—Å—Ç—É–ø–Ω—ã–º –º–∞—Å—Ç–µ—Ä–∞–º!


