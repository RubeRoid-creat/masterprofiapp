# Настройка интеграции с админ-панелью

## Проблема авторизации

Backend API требует авторизацию с токеном пользователя, имеющего роль 'client' или 'admin'.

## Решения

### Вариант 1: Создать специального пользователя для сайта (рекомендуется)

1. **Создать пользователя в backend:**

Через админ-панель или напрямую в БД:
```sql
-- Создать пользователя для сайта
INSERT INTO users (email, password_hash, name, phone, role, email_verified, phone_verified)
VALUES (
  'website@ispravleno.ru',
  'hashed_password_here', -- Используйте bcrypt для хеширования
  'Website Bot',
  '+79999999999',
  'client',
  1,
  1
);
```

2. **Получить токен:**

Войдите через API админ-панели:
```bash
curl -X POST http://212.74.227.208:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"website@ispravleno.ru","password":"your_password"}'
```

3. **Добавить токен в .env:**

```env
ADMIN_USER_TOKEN="полученный_jwt_токен"
```

### Вариант 2: Использовать существующего пользователя

Если у вас уже есть пользователь с ролью 'admin' или 'client':

1. Войдите через админ-панель
2. Получите токен из localStorage (в браузере: `localStorage.getItem('admin_token')`)
3. Добавьте в `.env`:
```env
ADMIN_USER_TOKEN="ваш_токен"
```

### Вариант 3: Добавить endpoint без авторизации в backend

Если хотите, чтобы сайт мог создавать заказы без авторизации:

1. Добавить в `Z:\BestAPP\backend\routes\orders.js`:

```javascript
// Создать заказ с сайта (без авторизации, но с проверкой API ключа)
router.post('/from-website', async (req, res) => {
  const apiKey = req.headers['x-api-key'];
  if (apiKey !== process.env.WEBSITE_API_KEY) {
    return res.status(401).json({ error: 'Invalid API key' });
  }
  
  // Создать заказ аналогично POST /orders
  // Но без требования authenticate middleware
});
```

2. Добавить в `.env` сайта:
```env
ADMIN_API_KEY="ваш_api_ключ"
```

3. Обновить `lib/admin-api.ts` для использования этого endpoint.

## Текущая настройка

После настройки одного из вариантов:

1. **Добавьте в `.env`:**
```env
NEXT_PUBLIC_ADMIN_API_URL="http://212.74.227.208:3000/api"
ADMIN_USER_TOKEN="ваш_токен_здесь"
```

2. **Перезапустите Next.js сервер:**
```powershell
npm run dev
```

3. **Протестируйте создание заказа:**
- Создайте заказ на сайте
- Проверьте в админ-панели, что заказ появился

## Проверка работы

1. Создайте заказ на http://localhost:3000/order
2. Проверьте логи сервера - должно быть сообщение об успешной отправке
3. Проверьте в админ-панели раздел "Заказы" - должен появиться новый заказ

## Обработка ошибок

Если отправка не удалась:
- Заказ все равно сохраняется в локальной БД сайта
- Ошибка логируется в консоль
- Пользователь получает успешный ответ

Это гарантирует, что заказы не теряются даже при проблемах с админ-панелью.

## Геокодинг адресов

Для получения реальных координат адреса можно использовать:
- Яндекс.Геокодер API
- Google Geocoding API
- Или использовать сервис из backend (если доступен)

Текущая реализация использует координаты Москвы по умолчанию.

