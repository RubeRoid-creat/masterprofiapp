# Интеграция с админ-панелью

## Обзор

Сайт интегрирован с админ-панелью для централизованного управления данными.

## Структура интеграции

### 1. API админ-панели

Админ-панель использует backend API:
- **Базовый URL:** `http://212.74.227.208:3000/api` (боевой сервер)
- **Локальный URL:** `http://localhost:3000/api` (для разработки)

### 2. Endpoints админ-панели

#### Заказы:
- `GET /api/orders` - получение всех заказов
- `GET /api/orders/:id` - получение заказа по ID
- `POST /api/orders` - создание заказа
- `POST /api/admin/orders/:id/assign` - назначение заказа мастеру
- `POST /api/admin/orders/:id/cancel` - отмена заказа

#### Статистика:
- `GET /api/admin/stats` - общая статистика
- `GET /api/admin/stats/orders?period=all` - статистика по заказам

#### Пользователи:
- `GET /api/admin/users` - список пользователей
- `POST /api/admin/users/:id/block` - блокировка пользователя

### 3. Интеграция на сайте

#### Создание заказа

При создании заказа на сайте:
1. Заказ сохраняется в локальную БД (Prisma)
2. Заказ отправляется в админ-панель через API
3. Админ-панель получает заказ и может назначить его мастеру

**Файл:** `app/api/orders/route.ts`
**Модуль:** `lib/admin-api.ts`

#### Формат данных

Сайт преобразует свои данные в формат админ-панели:

```typescript
// Данные сайта → Данные админ-панели
{
  name → client_name
  phone → client_phone
  email → client_email
  brand → device_brand
  equipmentType → device_type
  problemType + description → problem_description
  address → address
  date → scheduled_date
  time → scheduled_time
  status: 'new' → repair_status: 'new'
}
```

## Настройка

### Переменные окружения

Добавьте в `.env`:

```env
# URL админ-панели API (backend)
NEXT_PUBLIC_ADMIN_API_URL=http://212.74.227.208:3000/api

# Токен пользователя для авторизации (обязательно!)
# См. SETUP_ADMIN_INTEGRATION.md для получения токена
ADMIN_USER_TOKEN=your_jwt_token_here
```

### Для локальной разработки:

```env
NEXT_PUBLIC_ADMIN_API_URL=http://localhost:3000/api
ADMIN_USER_TOKEN=your_jwt_token_here
```

**ВАЖНО:** Backend требует авторизацию. См. `SETUP_ADMIN_INTEGRATION.md` для настройки.

## Синхронизация данных

### Заказы

Заказы автоматически синхронизируются:
- ✅ Создание заказа на сайте → отправка в админ-панель
- ⏳ Обновление статуса в админ-панели → синхронизация с сайтом (TODO)

### Новости

Новости можно синхронизировать через API (требует реализации в админ-панели):
- ⏳ Создание/редактирование в админ-панели → обновление на сайте
- ⏳ Удаление в админ-панели → удаление на сайте

### Прайс

Прайс можно синхронизировать через API (требует реализации в админ-панели):
- ⏳ Создание/редактирование в админ-панели → обновление на сайте
- ⏳ Удаление в админ-панели → удаление на сайте

### Форум

Форум использует локальную БД, но можно добавить модерацию через админ-панель:
- ⏳ Модерация тем через админ-панель
- ⏳ Удаление/блокировка через админ-панель

## Обработка ошибок

Если отправка в админ-панель не удалась:
- Заказ все равно сохраняется в локальной БД
- Ошибка логируется в консоль сервера
- Пользователь получает успешный ответ (заказ создан локально)

Это гарантирует, что заказы не теряются даже при проблемах с админ-панелью.

### Типичные ошибки:

1. **401 Unauthorized** - Не настроен `ADMIN_USER_TOKEN` или токен невалидный
   - Решение: См. `SETUP_ADMIN_INTEGRATION.md`

2. **403 Forbidden** - Пользователь не имеет прав на создание заказов
   - Решение: Убедитесь, что пользователь имеет роль 'client' или 'admin'

3. **400 Bad Request** - Неверный формат данных
   - Решение: Проверьте логи, данные должны соответствовать формату backend

4. **Сервер недоступен** - Backend не запущен или недоступен
   - Решение: Проверьте доступность `NEXT_PUBLIC_ADMIN_API_URL`

## Дальнейшая разработка

### TODO:

1. **Webhook для синхронизации статусов**
   - Админ-панель отправляет webhook при изменении статуса заказа
   - Сайт обновляет статус в локальной БД

2. **API для новостей в админ-панели**
   - Добавить endpoints для управления новостями
   - Синхронизировать с сайтом

3. **API для прайса в админ-панели**
   - Добавить endpoints для управления прайсом
   - Синхронизировать с сайтом

4. **Модерация форума**
   - Добавить endpoints для модерации тем
   - Интегрировать с админ-панелью

5. **Обратная связь**
   - Показывать сообщения обратной связи в админ-панели
   - Возможность ответа через админ-панель

## Тестирование

### Проверка интеграции:

1. Создайте заказ на сайте
2. Проверьте в админ-панели, что заказ появился
3. Назначьте заказ мастеру в админ-панели
4. Проверьте обновление статуса (после реализации webhook)

### Логирование:

Все ошибки интеграции логируются в консоль сервера Next.js.
Проверяйте логи при проблемах с синхронизацией.

