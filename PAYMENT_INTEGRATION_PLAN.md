# üìã –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (–ÆKassa + –ÆMoney)

## üéØ –¶–µ–ª—å
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ÆKassa –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ÆMoney –¥–ª—è –≤—ã–ø–ª–∞—Ç –º–∞—Å—Ç–µ—Ä–∞–º —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º.

---

## ‚úÖ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- ‚úÖ –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π (`payments` —Ç–∞–±–ª–∏—Ü–∞)
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ—à–µ–ª—å–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ (`master_transactions`)
- ‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –º–∞—Å—Ç–µ—Ä–∞
- ‚úÖ –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (15% basic, 10% premium)
- ‚úÖ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ yookassa –≤ –∫–æ–¥–µ

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa API
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆMoney API –¥–ª—è –≤—ã–ø–ª–∞—Ç
- ‚ùå Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ÆKassa
- ‚ùå –û–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞ (–§–ó-54 —á–µ–∫–∏)
- ‚ùå MLM-–≤—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆMoney

---

## üì¶ –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd backend
npm install @a2seven/yoo-checkout
```

---

## üîß –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

### 2.1. –°–µ—Ä–≤–∏—Å –ÆKassa (`services/yookassa-service.js`)
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–æ–≤ (–§–ó-54)

### 2.2. –°–µ—Ä–≤–∏—Å –ÆMoney (`services/yoomoney-service.js`)
- –í—ã–ø–ª–∞—Ç—ã –º–∞—Å—Ç–µ—Ä–∞–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–ª–∞—Ç
- –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç

### 2.3. MLM-—Å–µ—Ä–≤–∏—Å –≤—ã–ø–ª–∞—Ç (`services/mlm-payout-service.js`)
- –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –ø–æ —É—Ä–æ–≤–Ω—è–º MLM
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆMoney

---

## üóÑÔ∏è –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î

–î–æ–±–∞–≤–∏—Ç—å –≤ `payments`:
- `yookassa_payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa
- `receipt_id` - ID —á–µ–∫–∞ –æ–Ω–ª–∞–π–Ω-–∫–∞—Å—Å—ã
- `receipt_data` - JSON –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞

–î–æ–±–∞–≤–∏—Ç—å –≤ `master_transactions`:
- `yoomoney_payout_id` - ID –≤—ã–ø–ª–∞—Ç—ã –≤ –ÆMoney
- `payout_status` - —Å—Ç–∞—Ç—É—Å –≤—ã–ø–ª–∞—Ç—ã (pending/processing/completed/failed)

---

## üöÄ –®–∞–≥ 4: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è API endpoints

### 4.1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –ÆKassa
```
POST /api/payments/create-yookassa
Body: { orderId, amount, returnUrl }
Response: { paymentUrl, paymentId }
```

### 4.2. Webhook –æ—Ç –ÆKassa
```
POST /api/payments/webhook/yookassa
Body: Webhook –¥–∞–Ω–Ω—ã–µ –æ—Ç –ÆKassa
```

### 4.3. –í—ã–ø–ª–∞—Ç–∞ –º–∞—Å—Ç–µ—Ä—É —á–µ—Ä–µ–∑ –ÆMoney
```
POST /api/masters/wallet/payout-yoomoney
Body: { amount, masterId }
Response: { payoutId, status }
```

---

## üîê –®–∞–≥ 5: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```env
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOMONEY_CLIENT_ID=your_client_id
YOOMONEY_CLIENT_SECRET=your_client_secret
YOOMONEY_ACCESS_TOKEN=your_access_token

# –û–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞ (–§–ó-54)
OFD_PROVIDER=atol|online-kassa.ru
OFD_API_KEY=your_ofd_key
OFD_INN=your_inn
OFD_PAYMENT_ADDRESS=your_payment_address
```

---

## üìä –®–∞–≥ 6: –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```mermaid
graph TD
    A[–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑] --> B[–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –ÆKassa]
    B --> C[–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa]
    C --> D{–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞?}
    D -->|–î–∞| E[Webhook –æ—Ç –ÆKassa]
    D -->|–ù–µ—Ç| F[–û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞]
    E --> G[–°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–∞ –§–ó-54]
    G --> H[–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤]
    H --> I[70-80% –Ω–∞ –±–∞–ª–∞–Ω—Å –º–∞—Å—Ç–µ—Ä–∞]
    H --> J[15-25% –∫–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã]
    H --> K[3-5% MLM-–±–æ–Ω—É—Å—ã]
    I --> L[–ú–∞—Å—Ç–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É]
    L --> M[–í—ã–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆMoney/–°–ë–ü]
```

---

## üí∞ –®–∞–≥ 7: MLM-–≤—ã–ø–ª–∞—Ç—ã

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞:
1. –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –ø–æ —É—Ä–æ–≤–Ω—è–º MLM (3%, 2%, 1%)
2. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–∞ —Å—á–µ—Ç–∞—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ MLM
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–ø–ª–∞—Ç–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000 ‚ÇΩ)
4. –ò–ª–∏ —Ä—É—á–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É

---

## üì± –®–∞–≥ 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WebView –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞
- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–ª–∏–µ–Ω—Ç–∞

---

## ‚ö†Ô∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- ‚úÖ –û–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞ —Å —á–µ–∫–∞–º–∏ –ø–æ –§–ó-54 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- ‚úÖ PCI DSS compliance (–ÆKassa –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç)
- ‚úÖ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ (7 –¥–Ω–µ–π –¥–ª—è —É—Å–ª—É–≥)
- ‚úÖ –û—Ñ–µ—Ä—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

---

## üìÖ –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–≠—Ç–∞–ø 1** (1-2 –¥–Ω—è): –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –ÆKassa
2. **–≠—Ç–∞–ø 2** (2-3 –¥–Ω—è): –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ webhook'–æ–≤
3. **–≠—Ç–∞–ø 3** (1-2 –¥–Ω—è): –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆMoney –¥–ª—è –≤—ã–ø–ª–∞—Ç
4. **–≠—Ç–∞–ø 4** (2-3 –¥–Ω—è): MLM-–≤—ã–ø–ª–∞—Ç—ã
5. **–≠—Ç–∞–ø 5** (2-3 –¥–Ω—è): –û–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞ (–§–ó-54)
6. **–≠—Ç–∞–ø 6** (1-2 –¥–Ω—è): –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞

**–ò—Ç–æ–≥–æ: ~10-15 –¥–Ω–µ–π**

---

## üîÑ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
   - Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
   - –í—ã–ø–ª–∞—Ç—ã –º–∞—Å—Ç–µ—Ä–∞–º —á–µ—Ä–µ–∑ –ÆMoney

2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - –û–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞ (–§–ó-54)
   - MLM-–≤—ã–ø–ª–∞—Ç—ã
   - UI –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (–°–ë–ü, –°–±–µ—Ä–±–∞–Ω–∫)
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π






